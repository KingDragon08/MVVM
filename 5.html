<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>4</title>
</head>
<body>
    <!-- å¯¹ -->
    <!-- ä»è¿™ä¸ªç‰ˆæœ¬å¼€å§‹,æœ‰htmlä»£ç äº† -->
    <div id="app">
        <div id="a">{{a}}</div>
        <div id="b">{{b}}</div>
        <div id="c">
            <div id="d">{{b.d}}</div>
        </div>
        <div id="e">{{e}}</div>
        <input type="text" v-model="a">
    </div>
</body>
</html>


<script>
/**
 * 0.æœ€åŸå§‹çš„ç‰ˆæœ¬
 * 1.æ·»åŠ æ•°æ®åŠ«æŒçš„ç‰ˆæœ¬
 * 2.æ·»åŠ æ•°æ®ä»£ç†
 * 3.æ¨¡æ¿å­—ç¬¦ä¸²æ›¿æ¢(compile)
 * 4.æ•°æ®å•å‘ç»‘å®š, data => view
 * 5.æ•°æ®åŒå‘ç»‘å®š, data <=> view
 * compileçš„æ—¶å€™åˆ¤å®šv-modelæŒ‡å®š
 * æ£€æµ‹åˆ°v-modelååœ¨watcherçš„æ¿€æ´»å›è°ƒå†…è®¾ç½®nodeçš„valueå±æ€§ä¸ºæ–°å€¼,data => view
 * æ£€æµ‹åˆ°v-modelåæ·»åŠ inputç›‘å¬,è¾“å…¥æ¡†å€¼æ”¹å˜æ—¶æ”¹å˜ç»‘å®šçš„æ•°æ®é¡¹, view => data
 */


// å®šä¹‰ä¸€ä¸ªMVVMå¯¹è±¡
var MVVM = function (options) {
    this.$options = options;
    this.$data = options.data;
    /*
     * +++++++++++++++++++++++++++++++++++++++++++
     */
    // æ·»åŠ å…¨å±€è®¢é˜…è€…æ± å­
    this.dep = new Dep();
    /*
     * +++++++++++++++++++++++++++++++++++++++++++
     */
    // æ•°æ®åŠ«æŒ
    let data = options.data;
    this.observe(data);
    // æ•°æ®ä»£ç†
    this.proxy(data);
    // æ¨¡æ¿å­—ç¬¦ä¸²æ›¿æ¢
    this.compile();
}

/**
 * è®©æœ€æ–°çš„ä»£ç åœ¨æœ€å‰é¢ğŸ˜„
 * ç®€å•çš„å‘å¸ƒè®¢é˜…
 */
function Dep() {
    // åˆå§‹åŒ–è®¢é˜…è€…ä¸ºç©º
    this.subs = [];
}

// æ‰©å±•DepåŸå‹,ä½¿å…¶å…·æœ‰æ·»åŠ è®¢é˜…è€…å’Œé€šçŸ¥è®¢é˜…è€…çš„èƒ½åŠ›
Dep.prototype = {
    // æ·»åŠ è®¢é˜…è€…
    addSub: function (sub) {
        this.subs.push(sub);
    },
    // é€šçŸ¥è®¢é˜…è€…
    notify: function () {
        this.subs.forEach(function (sub) {
            // é»˜è®¤è°ƒç”¨è®¢é˜…è€…çš„updateæ–¹æ³•
            sub.update();
        });
    }
}

/**
 * è®¢é˜…è€…ç±»
 * vm  æŒ‡å‘å½“å‰çš„MVVMå®ä¾‹
 * arr {{a.b.c}}åŒæ‹¬å·å†…è¡¨è¾¾å¼åˆ‡åˆ†åçš„æ•°ç»„ [a,b,c]
 */
function Watcher(vm, arr, callback) {
    this.callback = callback;
    this.vm = vm; // æŒ‡å‘å½“å‰MVVMå®ä¾‹,updateæ—¶ç”¨äºå–å€¼
    this.arr = arr;
}

// æ‰©å±•WatcheråŸå‹,ä½¿å…·æœ‰ç»Ÿä¸€é»˜è®¤çš„updateæ–¹æ³•
Watcher.prototype.update = function () {
    let newVal = this.vm;
    // å–æœ€æ–°å€¼
    // è¿™æ„å‘³ç€æ›´æ–°è§†å›¾æ€»æ˜¯åœ¨æ›´æ–°æ•°æ®ä¹‹å
    this.arr.forEach(function (item) {
        newVal = newVal[item];
    });
    this.callback(newVal);
}

/**
 * æ¨¡æ¿å­—ç¬¦ä¸²æ›¿æ¢
 */
MVVM.prototype.compile = function (el, vm) {
    // åŒæ ·,æŠŠthiså®šæ­»
    let self = this;
    // è·å–æ ¹å…ƒç´ ,æŒ‚è½½åˆ°å®ä¾‹ä¸Š
    self.$el = document.querySelector(self.$options.el);
    // åˆ›å»ºä¸€ä¸ªæ–‡æ¡£ç¢ç‰‡
    let fragment = document.createDocumentFragment();
    // æ·»åŠ å­å…ƒç´ åˆ°ç¢ç‰‡ä¸­
    while (child = self.$el.firstChild) {
        fragment.appendChild(child);
    }
    replace(fragment);
    // æ¸²æŸ“DOM
    self.$el.appendChild(fragment);

    // å†…è”å·¥å…·å‡½æ•°,æ›¿æ¢èŠ‚ç‚¹å†…å®¹ä¸ºæ•°æ®æºæ•°æ®
    function replace(frag) {
        Array.from(frag.childNodes).forEach(function (node) {
            let txt = node.textContent;
            // æ­£åˆ™åŒ¹é…{{}},--*--delimitersé€‰é¡¹--*--
            let reg = /\{\{(.*?)\}\}/g;
            
            // èŠ‚ç‚¹æ˜¯divç±»å‹ä¸”å†…å®¹åŒ¹é…åˆ°{{}}
            if (node.nodeType == 1 && reg.test(txt)) {
                /**
                 * å–å‡ºè¦å±•ç¤ºçš„æ•°æ®çš„keyæ•°ç»„
                 * a.b.c åˆ™arrä¸­ä¸º [a, b, c]
                 */
                let arr = RegExp.$1.split('.');
                // å–åŸå§‹æ•°æ®æŒ‡é’ˆå‰¯æœ¬
                let val = self;
                arr.forEach(function (item) {
                    val = val[item];
                });    
                // éç®€å•ç±»å‹çš„æ•°æ®ç”¨jsonå½¢å¼è¿›è¡Œå±•ç¤º
                if (typeof(val) == 'object') {
                    val = JSON.stringify(val);
                }
                // å°†å€¼å±•ç¤ºå‡ºæ¥
                node.textContent = txt.replace(reg, val).trim();

                /*
                 * +++++++++++++++++++++++++++++++++++++++++++
                 */
                
                 // è®¢é˜…æ•°æ®
                 let watcher = new Watcher(self, arr, function (newVal) {
                    if (typeof(newVal) == 'object') {
                        newVal = JSON.stringify(newVal);
                    }
                    node.textContent = txt.replace(reg, newVal).trim();
                 });
                 self.dep.addSub(watcher);

                /*
                 * +++++++++++++++++++++++++++++++++++++++++++
                 */

                // é€’å½’å­èŠ‚ç‚¹
                if (node.childNodes && node.childNodes.length) {
                    replace(node);
                }
            }

            // åˆ¤æ–­inputè¾“å…¥æ¡†
            let attr = node.attributes;
            if (attr) {
                Array.from(attr).forEach(function(attr) {
                    if (attr.name == 'v-model') {
                        let exp = attr.value;
                        // åˆå§‹åŒ–è®¾ç½®å€¼
                        node.value = self[exp];
                        // æ·»åŠ è¾“å…¥ç›‘å¬
                        node.addEventListener('input', function (e) {
                            let newVal = e.target.value;
                            self[exp] = newVal;
                        });
                        // è®¢é˜…æ•°æ®
                        let watcher = new Watcher(self, [exp], function (newVal) {
                            if (typeof(newVal) == 'object') {
                               newVal = JSON.stringify(newVal);
                            }
                            // æ•°æ®åŒå‘ç»‘å®šçš„è¯,è®¾ç½®valueä¸ºæ–°å€¼
                            node.value = newVal;
                        });
                        self.dep.addSub(watcher);
                    }
                });    
            }
            
        });    
    }

}


/**
 * æ·»åŠ æ•°æ®ä»£ç†
 * ä¸ºä»€ä¹ˆä¸ç²—æš´çš„è®©this = this.$dataå‘¢ï¼Ÿ
 * æ¯•ç«Ÿthisè¿˜æœ‰å¾ˆå¤šå…¶ä»–äº‹æƒ…è¦å¹²çš„å˜›
 * é‚£å°±å¾€thisä¸Šé¢æŒ‚å±æ€§å’¯
 * ä»…ä»…æŠŠå±æ€§æŒ‚ä¸Šå»è¿˜ä¸è¡Œ,è¿™äº›å±æ€§è¢«æ›´æ”¹çš„æ—¶å€™è¦èƒ½å¤Ÿå¯¹åº”çš„æ›´æ”¹$dataæ•°æ®
 */
MVVM.prototype.proxy = function (data) {
    // åŒæ ·,æŠŠthiså®šæ­»
    let self = this;
    for (let key in data) {
        /**
         * ä¸ºå•¥ä¸é€’å½’äº†å‘¢?
         * åŒæ ·æ˜¯å› ä¸ºå¼•ç”¨ä¼ å‚,dataé‡Œé¢çš„æ•°æ®å·²ç»è¿›è¡Œè¿‡æ•°æ®åŠ«æŒäº†
         * ç°åœ¨åšçš„ç±»ä¼¼äºç»™ä»–èµ·ä¸ªåˆ«å
         * getæ–¹æ³•é‡Œé¢ä¼šè°ƒç”¨æ•°æ®åŠ«æŒé‡Œçš„getæ–¹æ³•
         * setæ–¹æ³•é‡Œé¢ç›´æ¥èµ‹å€¼çš„æ—¶å€™ä¼šç»è¿‡æ•°æ®åŠ«æŒé‡Œé¢çš„setæ–¹æ³•
         * æ‰€ä»¥ç›´æ¥èµ‹å€¼å°±okäº†
         */
        let val = data[key];
        Object.defineProperty(self, key, {
            configurable: true,
            get: function () {
                /**
                 * ä¸ºå•¥ä¸èƒ½è¿”å›val?
                 * å› ä¸ºself[key]ä¸ºç®€å•æ•°æ®ç±»å‹æ—¶,å¦‚Number
                 * æ­¤æ—¶self[key]é‡Œé¢å­˜çš„æ˜¯self.$data[key]çš„æ‹·è´
                 * self[key]å’Œself.$data[key]æŒ‡å‘çš„æ•°æ®ä¸ä¸€è‡´
                 */
                return self.$data[key];
            },
            set: function (newVal) {
                self.$data[key] = newVal;
            }
        });
    }
}

/**
 * dataæ˜¯Object,æ‰€ä»¥æ˜¯å¼•ç”¨ä¼ å‚
 * å¥½å¤„æ˜¯,ä¸ç®¡é€’å½’å¤šå°‘å±‚,æ”¹çš„éƒ½æ˜¯åŒä¸€ä»½æ•°æ®
 */ 
MVVM.prototype.observe = function (data) {
    // thisçš„ä½œç”¨åŸŸæœ‰ç‚¹é£˜,ç”¨selfå®šæ­»åˆ°è‡ªèº«
    let self = this;
    // éå†æ‰€æœ‰çš„key
    for (let key in data) {
        let val = data[key];
        // å¦‚æœç±»å‹æ˜¯objectçš„è¯,éœ€è¦é€’å½’è®¾ç½®getå’Œsetæ¥è¿›è¡Œæ•°æ®åŠ«æŒ
        if (typeof(val) === 'object') {
            self.observe(val);
        }
        /**
         * æœ€æ ¸å¿ƒçš„éƒ¨åˆ†äº†,æ•°æ®åŠ«æŒé€šè¿‡è¿™é‡Œå®ç°
         * ä¸ºå•¥ä¸å†™åˆ°elseé‡Œé¢?
         * å› ä¸ºobjectæœ¬èº«ä¹Ÿéœ€è¦è¿›è¡ŒåŠ«æŒ
         */
        Object.defineProperty(data, key, {
            configurable: true,
            get: function () {
                // ä¸èƒ½return data[key],å¦åˆ™ä¹‹åå–å€¼æ—¶ä¼šæ­»é€’å½’è°ƒç”¨getæ–¹æ³•
                return val;
            },
            set: function (newVal) {
                /* 
                 * ç®€å•ç±»å‹ä¸”å€¼é‡å¤çš„æ—¶å€™ç›´æ¥è¿”å›
                 * å¯¹è±¡ä¹‹é—´æ°¸è¿œä¸ä¼š ===
                 * å› ä¸ºå¯¹è±¡éƒ½æ˜¯ä¸ªæŒ‡é’ˆ,å³ä½¿å†…å®¹å®Œå…¨ä¸€è‡´,æŒ‡é’ˆåœ°å€ä¹Ÿä¸ä¸€æ ·
                 */
                if (newVal === val) {
                    return;
                }
                val = newVal;
                // å¦‚æœæ–°å€¼ä¹Ÿæ˜¯ä¸ªå¯¹è±¡çš„è¯,éœ€è¦é€’å½’åŠ å…¥æ•°æ®åŠ«æŒ
                if (typeof(newVal) === 'object') {
                    self.observe(newVal);
                }
                /*
                 * +++++++++++++++++++++++++++++++++++++++++++
                 */
                
                // é€šçŸ¥åˆ·æ–°
                 self.dep.notify();

                /*
                 * +++++++++++++++++++++++++++++++++++++++++++
                 */
            }
        });
    }
}

// newä¸€ä¸ªã€å¯¹è±¡ã€‘è¿›è¡Œæµ‹è¯•
var vm = new MVVM({
    el: '#app',
    data: {
        a: 1,
        b: {
            c: 2,
            d: 3
        },
        e: [1,2,3]
    }
});
console.log(vm);

</script>