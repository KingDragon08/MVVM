<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>3</title>
</head>
<body>
    <!-- å¯¹ -->
    <!-- ä»è¿™ä¸ªç‰ˆæœ¬å¼€å§‹,æœ‰htmlä»£ç äº† -->
    <div id="app">
        <div id="a">{{a}}</div>
        <div id="b">{{b}}</div>
        <div id="c">
            <div id="d">{{b.d}}</div>
        </div>
        <div id="e">{{e}}</div>
    </div>
</body>
</html>


<script>
/**
 * 0.æœ€åŸå§‹çš„ç‰ˆæœ¬
 * 1.æ·»åŠ æ•°æ®åŠ«æŒçš„ç‰ˆæœ¬
 * 2.æ·»åŠ æ•°æ®ä»£ç†
 * 3.æ¨¡æ¿å­—ç¬¦ä¸²æ›¿æ¢(compile)
 */


// å®šä¹‰ä¸€ä¸ªMVVMå¯¹è±¡
var MVVM = function (options) {
    this.$options = options;
    this.$data = options.data;
    // æ•°æ®åŠ«æŒ
    let data = options.data;
    this.observe(data);
    // æ•°æ®ä»£ç†
    this.proxy(data);
    // æ¨¡æ¿å­—ç¬¦ä¸²æ›¿æ¢
    this.compile();
}

/**
 * è®©æœ€æ–°çš„ä»£ç åœ¨æœ€å‰é¢ğŸ˜„
 * æ¨¡æ¿å­—ç¬¦ä¸²æ›¿æ¢
 */
MVVM.prototype.compile = function (el, vm) {
    // åŒæ ·,æŠŠthiså®šæ­»
    let self = this;
    // è·å–æ ¹å…ƒç´ ,æŒ‚è½½åˆ°å®ä¾‹ä¸Š
    self.$el = document.querySelector(self.$options.el);
    // åˆ›å»ºä¸€ä¸ªæ–‡æ¡£ç¢ç‰‡
    let fragment = document.createDocumentFragment();
    // æ·»åŠ å­å…ƒç´ åˆ°ç¢ç‰‡ä¸­
    while (child = self.$el.firstChild) {
        fragment.appendChild(child);
    }
    replace(fragment);
    // æ¸²æŸ“DOM
    self.$el.appendChild(fragment);

    // å†…è”å·¥å…·å‡½æ•°,æ›¿æ¢èŠ‚ç‚¹å†…å®¹ä¸ºæ•°æ®æºæ•°æ®
    function replace(frag) {
        Array.from(frag.childNodes).forEach(function (node) {
            let txt = node.textContent;
            // æ­£åˆ™åŒ¹é…{{}},--*--delimitersé€‰é¡¹--*--
            let reg = /\{\{(.*?)\}\}/g;
            // èŠ‚ç‚¹æ˜¯divç±»å‹ä¸”å†…å®¹åŒ¹é…åˆ°{{}}
            if (node.nodeType == 1 && reg.test(txt)) {
                /**
                 * å–å‡ºè¦å±•ç¤ºçš„æ•°æ®çš„keyæ•°ç»„
                 * a.b.c åˆ™arrä¸­ä¸º [a, b, c]
                 */
                let arr = RegExp.$1.split('.');
                // å–åŸå§‹æ•°æ®æŒ‡é’ˆå‰¯æœ¬
                let val = self;
                arr.forEach(function (item) {
                    val = val[item];
                });
                // éç®€å•ç±»å‹çš„æ•°æ®ç”¨jsonå½¢å¼è¿›è¡Œå±•ç¤º
                if (typeof(val) == 'object') {
                    val = JSON.stringify(val);
                }
                // å°†å€¼å±•ç¤ºå‡ºæ¥
                node.textContent = txt.replace(reg, val).trim();
                // é€’å½’å­èŠ‚ç‚¹
                if (node.childNodes && node.childNodes.length) {
                    replace(node);
                }
            }
        });    
    }

}


/**
 * æ·»åŠ æ•°æ®ä»£ç†
 * ä¸ºä»€ä¹ˆä¸ç²—æš´çš„è®©this = this.$dataå‘¢ï¼Ÿ
 * æ¯•ç«Ÿthisè¿˜æœ‰å¾ˆå¤šå…¶ä»–äº‹æƒ…è¦å¹²çš„å˜›
 * é‚£å°±å¾€thisä¸Šé¢æŒ‚å±æ€§å’¯
 * ä»…ä»…æŠŠå±æ€§æŒ‚ä¸Šå»è¿˜ä¸è¡Œ,è¿™äº›å±æ€§è¢«æ›´æ”¹çš„æ—¶å€™è¦èƒ½å¤Ÿå¯¹åº”çš„æ›´æ”¹$dataæ•°æ®
 */
MVVM.prototype.proxy = function (data) {
    // åŒæ ·,æŠŠthiså®šæ­»
    let self = this;
    for (let key in data) {
        /**
         * ä¸ºå•¥ä¸é€’å½’äº†å‘¢?
         * åŒæ ·æ˜¯å› ä¸ºå¼•ç”¨ä¼ å‚,dataé‡Œé¢çš„æ•°æ®å·²ç»è¿›è¡Œè¿‡æ•°æ®åŠ«æŒäº†
         * ç°åœ¨åšçš„ç±»ä¼¼äºç»™ä»–èµ·ä¸ªåˆ«å
         * getæ–¹æ³•é‡Œé¢ä¼šè°ƒç”¨æ•°æ®åŠ«æŒé‡Œçš„getæ–¹æ³•
         * setæ–¹æ³•é‡Œé¢ç›´æ¥èµ‹å€¼çš„æ—¶å€™ä¼šç»è¿‡æ•°æ®åŠ«æŒé‡Œé¢çš„setæ–¹æ³•
         * æ‰€ä»¥ç›´æ¥èµ‹å€¼å°±okäº†
         */
        let val = data[key];
        Object.defineProperty(self, key, {
            configurable: true,
            get: function () {
                /**
                 * ä¸ºå•¥ä¸èƒ½è¿”å›val?
                 * å› ä¸ºself[key]ä¸ºç®€å•æ•°æ®ç±»å‹æ—¶,å¦‚Number
                 * æ­¤æ—¶self[key]é‡Œé¢å­˜çš„æ˜¯self.$data[key]çš„æ‹·è´
                 * self[key]å’Œself.$data[key]æŒ‡å‘çš„æ•°æ®ä¸ä¸€è‡´
                 */
                return self.$data[key];
            },
            set: function (newVal) {
                self.$data[key] = newVal;
            }
        });
    }
}

/**
 * dataæ˜¯Object,æ‰€ä»¥æ˜¯å¼•ç”¨ä¼ å‚
 * å¥½å¤„æ˜¯,ä¸ç®¡é€’å½’å¤šå°‘å±‚,æ”¹çš„éƒ½æ˜¯åŒä¸€ä»½æ•°æ®
 */ 
MVVM.prototype.observe = function (data) {
    // thisçš„ä½œç”¨åŸŸæœ‰ç‚¹é£˜,ç”¨selfå®šæ­»åˆ°è‡ªèº«
    let self = this;
    // éå†æ‰€æœ‰çš„key
    for (let key in data) {
        let val = data[key];
        // å¦‚æœç±»å‹æ˜¯objectçš„è¯,éœ€è¦é€’å½’è®¾ç½®getå’Œsetæ¥è¿›è¡Œæ•°æ®åŠ«æŒ
        if (typeof(val) === 'object') {
            self.observe(val);
        }
        /**
         * æœ€æ ¸å¿ƒçš„éƒ¨åˆ†äº†,æ•°æ®åŠ«æŒé€šè¿‡è¿™é‡Œå®ç°
         * ä¸ºå•¥ä¸å†™åˆ°elseé‡Œé¢?
         * å› ä¸ºobjectæœ¬èº«ä¹Ÿéœ€è¦è¿›è¡ŒåŠ«æŒ
         */
        Object.defineProperty(data, key, {
            configurable: true,
            get: function () {
                // ä¸èƒ½return data[key],å¦åˆ™ä¹‹åå–å€¼æ—¶ä¼šæ­»é€’å½’è°ƒç”¨getæ–¹æ³•
                return val;
            },
            set: function (newVal) {
                /* 
                 * ç®€å•ç±»å‹ä¸”å€¼é‡å¤çš„æ—¶å€™ç›´æ¥è¿”å›
                 * å¯¹è±¡ä¹‹é—´æ°¸è¿œä¸ä¼š ===
                 * å› ä¸ºå¯¹è±¡éƒ½æ˜¯ä¸ªæŒ‡é’ˆ,å³ä½¿å†…å®¹å®Œå…¨ä¸€è‡´,æŒ‡é’ˆåœ°å€ä¹Ÿä¸ä¸€æ ·
                 */
                if (newVal === val) {
                    return;
                }
                val = newVal;
                // å¦‚æœæ–°å€¼ä¹Ÿæ˜¯ä¸ªå¯¹è±¡çš„è¯,éœ€è¦é€’å½’åŠ å…¥æ•°æ®åŠ«æŒ
                if (typeof(newVal) === 'object') {
                    self.observe(newVal);
                }
            }
        });
    }
}

// newä¸€ä¸ªã€å¯¹è±¡ã€‘è¿›è¡Œæµ‹è¯•
var vm = new MVVM({
    el: '#app',
    data: {
        a: 1,
        b: {
            c: 2,
            d: 3
        },
        e: [1,2,3]
    }
});
console.log(vm);

</script>